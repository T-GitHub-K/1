CODE SEGMENT
	ASSUME CS:CODE,DS:CODE,SS:STSEG

PRINTS	MACRO	STRING
	MOV	DX,OFFSET STRING
	MOV	AH,09H
	INT	21H
	ENDM

START:	CLD
	MOV	AX,CS
	MOV	DS,AX
	CALL	GSTAT
	JB	TEXIT
	MOV	DX,103H
	CALL	GMDST
	JB	TEXIT
	PRINTS	TXCLR
	CALL	GCLS

MLOOP:	MOV	SI,OFFSET WORKS
	MOV	CX,400
SLOOP:	PUSH	CX
	CALL	DMOVE
	ADD	SI,8
	POP	CX
	LOOP	SLOOP
	MOV	AX,400H
	INT	18H
	TEST	AH,1
	JE	MLOOP
	JMP	TEXIT
	CALL	GTERM
	PRINTS	TKEEP
TEXIT:	;MOV	AX,0C00H
	;INT	21H
	MOV	AX,4C00H
	INT	21H

DMOVE	PROC
	MOV	CL,[SI+0]
	OR	CL,CL
	JE	NEWDT
	MOV	BX,[SI+5]
	MOV	DL,[SI+7]
	CALL	DOTOF
	MOV	DX,[SI+1]
	XOR	AX,AX
	MOV	AL,CL
	AND	AL,00000111B
	ADD	AX,[SI+3]
	CMP	AX,400
	JB	CALPS
	MOV	BYTE PTR [SI+0],0
	JMP	DMORT
NEWDT:	CALL	RND
	CMP	AL,15
	JNB	DMORT
	INC	AL
	ROL	AL,1
	ROL	AL,1
	ROL	AL,1
	MOV	CL,AL
	MOV	DX,NEWXX
	ADD	DX,33
	CMP	DX,640
	JB	NEWD1
	SUB	DX,640
NEWD1:	MOV	NEWXX,DX
	MOV	[SI+1],DX
	CALL	RND
	AND	AL,00000011B
	INC	AL
	OR	AL,CL
	MOV	[SI+0],AL
	MOV	CL,AL
	XOR	AX,AX
CALPS:	MOV	[SI+3],AX
	MOV	BX,AX
	SHR	CL,1
	SHR	CL,1
	SHR	CL,1
	CALL	PSETC
	MOV	[SI+5],BX
	MOV	[SI+7],DL
DMORT:	RET
NEWXX	DW	0
DMOVE	ENDP

PSETC	PROC
	PUSH	CX
	MOV	AL,10000000B
	SHR	DX,1
	JNB	RRDE1
	ROR	AL,1
RRDE1:	SHR	DX,1
	JNB	RRDE2
	ROR	AL,1
	ROR	AL,1
RRDE2:	SHR	DL,1
	JNB	RRDE3
	ROR	AL,1
	ROR	AL,1
	ROR	AL,1
	ROR	AL,1
RRDE3:	ADD	BX,BX
	ADD	BX,BX
	ADD	BX,BX
	ADD	BX,BX
	MOV	CX,BX
	ADD	BX,BX
	ADD	BX,BX
	ADD	BX,CX
	ADD	BX,DX
	MOV	DH,AL
	NOT	AL
	MOV	DL,AL
	POP	CX
	PUSH	DX
	MOV	AX,BLUE
	MOV	DS,AX
	AND	[BX],DL
	RCR	CL,1
	JNB	NOST1
	OR	[BX],DH
NOST1:	MOV	AX,RED
	MOV	DS,AX
	AND	[BX],DL
	RCR	CL,1
	JNB	NOST2
	OR	[BX],DH
NOST2:	MOV	AX,GREEN
	MOV	DS,AX
	AND	[BX],DL
	RCR	CL,1
	JNB	NOST3
	OR	[BX],DH
NOST3:	MOV	AX,ITSTY
	MOV	DS,AX
	AND	[BX],DL
	RCR	AL,1
	JNB	NOST4
	OR	[BX],DH
NOST4:	POP	DS
	RET
PSETC	ENDP

DOTOF	PROC
	PUSH	DS
	MOV	AX,BLUE
	MOV	DS,AX
	AND	[BX],DL
	MOV	AX,RED
	MOV	DS,AX
	AND	[BX],DL
	MOV	AX,GREEN
	MOV	DS,AX
	AND	[BX],DL
	MOV	AX,ITSTY
	MOV	DS,AX
	AND 	[BX],DL
	POP	DS
	RET
DOTOF	ENDP

RND	PROC
	PUSH	BX
	MOV	BX,RNDDT
	ADD	BX,BX
	ADD	BX,BX
	ADD	BX,RNDDT
	ADD	BX,1357H
	MOV	RNDDT,BX
	MOV	AL,BH
	POP	BX
	RET
RNDDT	DW	3478H
RND	ENDP

WORKS	DB	8*400 DUP(0)

G_START	EQU	0
G_TERM	EQU	1
G_MODE_SET	EQU	3
G_SWITCH	EQU	11

GSTAT	PROC
	CALL	CDRIV
	JB	GSTRT
	MOV	GSTSIN,1
	PUSH	DS
	MOV	BX,OFFSET GDADR
	XOR	AX,AX
	INT	0CDH
	MOV	SI,G_START
	CALL	GCALL
	CALL	GDSET
	MOV	AL,0FH
	MOV	[SI+4],AL
	MOV	SI,G_SWITCH
	CALL	GCALL
	POP	DS
GSTRT:	RET
GSTAT	ENDP

D_NAME	DB	'A:\DOS\GRAPH.SYS',0

CDRIV	PROC
	MOV	AX,3D00H
	MOV	DX,OFFSET D_NAME
	INT	21H
	JC	CDR01
	MOV	BX,AX
	MOV	AH,3EH
	INT	21H
	CLC
	JMP	CDRRT
CDR01:	PRINTS	GOPER
	STC
CDRRT:	RET
CDRIV	ENDP

GMDST	PROC
	PUSH	DS
	CALL	GDSET
	XOR	AX,AX
	MOV	[SI],AX
	MOV	[SI+2],AX
	MOV	[SI+4],DX
	MOV	SI,G_MODE_SET
	CALL	GCALL
	POP	DS
	AND	AX,AX
	JZ	GMDRT
	STC
GMDRT:	RET
GMDST	ENDP

GTERM	PROC
	CMP	BYTE PTR GSTSIN,1
	JNE	GTERT
	MOV	GSTSIN,0
	PUSH	DS
	MOV	SI,G_TERM
	CALL	GCALL
	POP	DS
GTERT:	RET
GTERM	ENDP

GCLS	PROC
	PUSH	DS
	CALL	GDSET
	XOR	AX,AX
	MOV	[SI],AX
	MOV	[SI+2],AX
	MOV	SI,14
	CALL	GCALL
	POP	DS
GCLS	ENDP

GDSET	PROC
	MOV	AX,PMSEG
	MOV	DS,AX
	MOV	SI,OFFSET PBLOC
	RET
GDSET	ENDP

GCALL	PROC
	PUSH	WORD PTR CS:GDSEG
	PUSH	WORD PTR CS:GDOFF
	LDS	BX,CS:GDADR
	SHL	SI,1
	SHL	SI,1
	CALL	DWORD PTR [BX+SI]
	RET
GCALL	ENDP

GSTSIN	DB	0
GDADR	DD	0
GDOFF	DW	0
GDSEG	DW	PMSEG
GOPER	DB	"GRAPH.SYS ÄÞ×²ÊÞ‚ª–¢“o˜^‚Å‚·B$"


TXCLR	LABEL	BYTE
	DB	1BH,"[1J"
	DB	1BH,"[s",1BH,"[>5h",1BH,"[1>h$"

TKEEP	LABEL	BYTE
	DB	1BH,"[u",1BH,"[>5l",1BH,"[1>l$"

CODE	ENDS

PMSEG	SEGMENT
	PBLOC	DB	48 DUP(0)
	WBLOC	DB	2000 DUP(0)
PMSEG	ENDS

STSEG	SEGMENT	STACK
	DB	100H DUP(?)
STSEG	ENDS

BLUE	SEGMENT	AT 0A800H
BLUE	ENDS
	
RED	SEGMENT	AT 0B000H
RED	ENDS

GREEN	SEGMENT	AT 0B800H
GREEN	ENDS

ITSTY	SEGMENT	AT 0E000H
ITSTY	ENDS

	END
