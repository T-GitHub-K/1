INCLUDE	MDOS.H
INCLUDE	UTY.H
INCLUDE	BIOS.H
INCLUDE	MACRO.H
INCLUDE	STD.H

;-------------------    色指定

TI1_FGC	EQU	7				;西暦ﾀｲﾄﾙ前月
TI1_BGC	EQU	1

TI2_FGC	EQU	7				;西暦ﾀｲﾄﾙ当月
TI2_BGC	EQU	2

TI3_FGC	EQU	7				;西暦ﾀｲﾄﾙ次月
TI3_BGC	EQU	3


CODE	SEGMENT	PUBLIC
	ASSUME	CS:CODE,DS:CODE,SS:CODE,ES:CODE

	ORG	100H
S:

	MOV	AX,2A00H			;ｼｽﾃﾑの年月日を取得
	INT	21H

	MOV	Y0,CX				;年
	MOV	M0,DH				;月

	MOV	YY,CX				;年
	MOV	MDAY,DX				;月,日

	MOV	CL,6AH				;有効SCREEN ﾓｰﾄﾞ設定
	MOV	AH,1				;
	MOV	AL,2				;ﾃｷｽﾄ & ｸﾞﾗﾌｨｯｸ
	MOV	DL,2				;VRAM ﾃｷｽﾄ & ｸﾞﾗﾌｨｯｸ有効
	PUSH	ES
	INT	80H
	POP	ES
	
	CALL	SUB_Z1
	CALL	SUB_GR

	COLOR_M 0,0				;
	BIOS_42	0
	DISPLAY_CHAR	CLS

	LOCATE_M 18,0
	COLOR_M	6,0
	BIOS_D7	MSG

	JMP	M6

S1:
	COLOR_M 0,0
	INPUT_M	0,0,STR,4,6,0
	

		MOV	CX,4
		MOV	SI,DI
		MOV	DI,OFFSET STR
	REP	MOVSB

	INPUT_M	1,0,STR1,2,6,0

		MOV	CX,2
		MOV	SI,DI
		MOV	DI,OFFSET STR1
	REP	MOVSB

		MOV	Y0,0
		MOV	M0,0
		MOV	DC,0
		MOV	UC,0

		XOR	AX,AX
		MOV	BX,1
		MOV	AL,STR[3]
		CMP	AL,30H
		JB	M1
		SUB	AL,30H
		ADD	Y0,AX
		MOV	AX,BX
		MOV	BX,10
		MUL	BX
		MOV	BX,AX
M1:
		XOR	AX,AX
		MOV	AL,STR[2]
		CMP	AL,30H
		JB	M2
		SUB	AL,30H
		MUL	BX
		ADD	Y0,AX
		MOV	AX,BX
		MOV	BX,10
		MUL	BX
		MOV	BX,AX

M2:		
		XOR	AX,AX
		MOV	AL,STR[1]
		CMP	AL,30H
		JB	M3
		SUB	AL,30H
		MUL	BX
		ADD	Y0,AX
		MOV	AX,BX
		MOV	BX,10
		MUL	BX
		MOV	BX,AX

M3:
		XOR	AX,AX
		MOV	AL,STR[0]
		CMP	AL,30H
		JB	M4
		SUB	AL,30H
		MUL	BX
		ADD	Y0,AX
		MOV	AX,BX
		MOV	BX,10
		MUL	BX
		MOV	BX,AX

M4:
		XOR	AX,AX
		MOV	BX,1
		MOV	AL,STR1[1]
		CMP	AL,30H
		JB	M5
		SUB	AL,30H
		ADD	M0,AL
		MOV	AX,BX
		MOV	BX,10
		MUL	BX
		MOV	BX,AX

M5:
		XOR	AX,AX
		MOV	AL,STR1[0]
		CMP	AL,30H
		JB	M6
		SUB	AL,30H
		MUL	BX
		ADD	M0,AL

M6:
		LOCATE_M 11,0
		BIOS_D7	CLS_LINE

M10:
		CMP	M0,1
		JAE	M11
		MOV	M0,12
		DEC	Y0
M11:
		CMP	M0,12
		JBE	M12
		MOV	M0,1
		INC	Y0
M12:
		CMP	Y0,1
		JAE	M13
		MOV	Y0,1
		MOV	M0,2
M13:
		CMP	Y0,1
		JNE	M14
		CMP	M0,1
		JNE	M14
		MOV	M0,2
M14:
;JMP	M16

		MOV	HY,8
		MOV	HX,5
		XOR	AX,AX
		MOV	AL,M0
		ADD	AL,10
		MOV	BX,12
		XOR	DX,DX
		DIV	BX
		MOV	AX,DX
		INC	AX
		MOV	M,AL

		MOV	AX,Y0
		MOV	Y,AX
		CMP	M,12
		JNE	M15
		DEC	Y

M15:
		COLOR_M TI1_FGC,TI1_BGC
		MOV	BX,Y
		CALL	SUB_S1
		MOV	STR[0],CH
		MOV	STR[1],CL
		MOV	STR[2],BH
		MOV	STR[3],BL
		XOR	BX,BX
		MOV	BL,M
		CALL	SUB_S
		MOV	STR1[0],BH
		MOV	STR1[1],BL
		CALL	SUB
M16:
		MOV	HY,8
		MOV	HX,30
		MOV	AX,Y0
		MOV	Y,AX
		MOV	AL,M0
		MOV	M,AL

		COLOR_M TI2_FGC,TI2_BGC
		MOV	BX,Y
		CALL	SUB_S1
		MOV	STR[0],CH
		MOV	STR[1],CL
		MOV	STR[2],BH
		MOV	STR[3],BL
		XOR	BX,BX
		MOV	BL,M
		CALL	SUB_S
		MOV	STR1[0],BH
		MOV	STR1[1],BL
		CALL	SUB
;JMP	M18_1

M17:

		MOV	HY,8
		MOV	HX,55
		MOV	AX,Y0
		MOV	Y,AX
		XOR	AX,AX
		MOV	AL,M0
		ADD	AL,12
		MOV	M,AL
		MOV	BX,12
		XOR	DX,DX
		DIV	BX
		MOV	AL,DL
		INC	AL
		MOV	M,AL
		CMP	AL,1
		JNE	M18
		INC	Y
M18:
		COLOR_M TI3_FGC,TI3_BGC
		MOV	BX,Y
		CALL	SUB_S1
		MOV	STR[0],CH
		MOV	STR[1],CL
		MOV	STR[2],BH
		MOV	STR[3],BL
		XOR	BX,BX
		MOV	BL,M
		CALL	SUB_S
		MOV	STR1[0],BH
		MOV	STR1[1],BL
		CALL	SUB
M18_1:
		BIOS_18

		CMP	AL,0BH
		JNE	M19
		DEC	Y0
		JMP	M_EXIT
M19:
		CMP	AL,0AH
		JNE	M20
		INC	Y0
		JMP	M_EXIT
M20:
		CMP	AL,0CH
		JNE	M21
		INC	M0
		JMP	M_EXIT
M21:
		CMP	AL,8H
		JNE	M22
		DEC	M0
M_EXIT:
		JMP	M6
M22:
		CMP	AL,"*"
		JZ	EXIT
		
		CMP	AL,"\"
		JZ	M23
		BIOS_29	BEEP
		JMP	M18_1
M23:
		JMP	S1
EXIT:
		COLOR_M 7,0,0,0
		BIOS_42	1
		CALL	SUB_GR1
		DISPLAY_CHAR	CLS
		END_PROCESS	0
	
SUB	PROC	NEAR
	MOV	UFLG,0
	XOR	DX,DX
	MOV	AX,Y
	MOV	BX,4
	DIV	BX
	OR	DX,DX
	JNE	SUB1
	MOV	UFLG,1
SUB1:
	XOR	DX,DX
	MOV	AX,Y
	MOV	BX,100
	DIV	BX
	OR	DX,DX
	JNE	SUB2
	MOV	UFLG,0
SUB2:
	XOR	DX,DX
	MOV	AX,Y
	MOV	BX,400
	DIV	BX
	OR	DX,DX
	JNE	SUB3
	MOV	UFLG,1
SUB3:
	MOV	AH,UFLG
	OR	AH,AH
	JZ	SUB3_5
	MOV	MON[2],29
	JMP	SUB4
SUB3_5:
	MOV	MON[2],28
SUB4:
	MOV	AX,Y
	MOV	UC,AX
	DEC	AX
	XOR	DX,DX
	MOV	BX,4
	DIV	BX
	ADD	UC,AX
	
	MOV	AX,Y
	DEC	AX
	XOR	DX,DX
	MOV	BX,100
	DIV	BX
	SUB	UC,AX

	MOV	AX,Y
	DEC	AX
	XOR	DX,DX
	MOV	BX,400
	DIV	BX
	ADD	UC,AX

	MOV	AX,UC
	MOV	DC,AX
	XOR	CX,CX
	MOV	CL,M
	MOV	AX,DC
	DEC	CX
	OR	CX,CX
	JZ	SUBLOOP_EXIT
	MOV	BX,1
SUBLOOP:
	XOR	DX,DX
	MOV	DL,BYTE PTR MON[BX]
	ADD	AX,DX
	INC	BX
	LOOP	SUBLOOP
SUBLOOP_EXIT:
	MOV	BX,7
	XOR	DX,DX
	DIV	BX
	MOV	BYTE PTR WEEK,DL

	LOCATE_M HY,HX
	BIOS_D7	TI
	BIOS_D7 STR
	BIOS_D7	TI1
	BIOS_D7	STR1
	BIOS_D7	TI2
	ADD	HY,2
	LOCATE_M HY,HX
	MOV	CX,7
	XOR	BX,BX
	XOR	SI,SI
SUBLOOP1:
	COLOR_M	WEKC[SI],0		
	DISPLAY_CHAR	<BYTE PTR W[BX+1]>
	DISPLAY_CHAR	<BYTE PTR W[BX]>
	DISPLAY_CHAR	20H
	ADD	BX,2
	INC	SI
	LOOP	SUBLOOP1

	ADD	HY,1
	LOCATE_M HY,HX
	XOR	CX,CX
	MOV	CL,WEEK
	OR	CX,CX
	JZ	SUBLOOP2_EXIT
SUBLOOP2:
	PUSH	CX
	BIOS_29	20H
	BIOS_29	20H
	BIOS_29	20H
	POP	CX
	LOOP	SUBLOOP2
SUBLOOP2_EXIT:
	XOR	BX,BX
	MOV	BL,M
	XOR	CX,CX
	MOV	CL,MON[BX]
	MOV	BX,1
SUBLOOP3:
	CALL	SUB_ZOKU
	CMP	FLG1,1
	JNE	SUB5_0
	CALL	SUB_Z
SUB5_0:
	
	PUSH	CX
	PUSH	BX
	XOR	BX,BX
	MOV	BL,BYTE PTR WEEK
	MOV	SI,BX
	CMP	FLG,1
	JZ	SUB5_5	
	COLOR_M	WEKC[SI],0
	JMP	SUB5_6
SUB5_5:
	COLOR_M 3,0
SUB5_6:
	POP	BX
	PUSH	BX
	CALL	SUB_WDAY
;	ADD	BX,BX
;	MOV	DH,BYTE PTR WDAY1[BX+1]
;	MOV	DL,BYTE PTR WDAY1[BX]	
	CMP	BL,10
	JAE	SUB5
	ADD	BL,30H
	MOV	BH,20H
	JMP	SHORT SUB6
SUB5:
	CALL	SUB_S
SUB6:
	MOV	DX,BX
	POP	BX
	CMP	WEEK,0
	JNE	SUB7
	CMP	BL,1
	JZ	SUB7
	INC	HY
	LOCATE_M HY,HX
SUB7:
	PUSHA
	BIOS_29	DH
	POPA
	PUSHA
	BIOS_29	DL
	CMP	FLG1,1
	JNE	SUB7_6
	CALL	SUB_Z1
SUB7_6:
	BIOS_29	20H
	POPA
	INC	WEEK
	XOR	AX,AX
	MOV	AL,WEEK
	PUSH	BX
	MOV	BX,7
	XOR	DX,DX
	DIV	BX
	MOV	BYTE PTR WEEK,DL
	POP	BX
	INC	BX
	POP	CX
	DEC	CX
	JZ	SUB_EXIT
	JMP	SUBLOOP3

SUB_EXIT:

	MOV	CL,6AH				;有効SCREEN ﾓｰﾄﾞ設定
	MOV	AH,1				;
	MOV	AL,0				;ﾃｷｽﾄ ONLY
	MOV	DL,0				;VRAM ﾃｷｽﾄ ONLY
	PUSH	ES
	INT	80H
	POP	ES

	RET

	




MON	DB	0,31,28,31,30,31,30,31,31,30,31,30,31
W	DW	"日","月","火","水","木","金","土"
WEKC	DB	2,7,7,7,7,7,5
WDAY	DW	0101H,010FH,020BH,0315H,041DH,0503H,0504H,0505H,090FH
	DW	0917H,0A0AH,0B03H,0B17H,0C17H

WDAY1	DW	2020H
	DW	2031H,2032H,2033H,2034H,2035H,2036H,2037H,2038H,2039H,3130H
	DW	3131H,3132H,3133H,3134H,3135H,3136H,3137H,3138H,3139H,3230H
	DW	3231H,3232H,3233H,3234H,3235H,3236H,3237H,3238H,3239H,3330H
	DW	3331H

STR	DB	"1992"
	DB	"$"
STR1	DB	"10"
	DB	"$"
STR2	DB	0

Y	DW	0
UFLG	DB	0
UC	DW	0
DC	DW	0
M	DB	0
WEEK	DB	0
HY	DB	8
HX	DB	5
TI	DB	" 西暦 ","$"
TI1	DB	" 年 ","$"
TI2	DB	" 月 ",CR,LF,"$"
C	DB	0
FLG	DB	0
Y0	DW	1992
M0	DB	10
MSG	DB	"                                      前年         ",CR,LF
	DB	"                                       ↑          ",CR,LF
	DB	"                                前月 ←  → 次月   ",CR,LF
	DB	"                                       ↓          ",CR,LF
	DB	"                                      次年         ",CR,LF
	DB	"                                                   "
	DB	"終了するときは 〈＊〉を押す","$"

YY	DW	0
MDAY	DW	0
FLG1	DB	0

GRCO	DB	48 DUP(0)

CLS_LINE	DB	78 DUP(20H)
		DB	CR,LF
		DB	78 DUP(20H)
		DB	CR,LF
		DB	78 DUP(20H)
		DB	CR,LF
		DB	78 DUP(20H)
		DB	CR,LF
		DB	78 DUP(20H)
		DB	CR,LF
		DB	78 DUP(20H)
		DB	CR,LF,"$"


SUB	ENDP


SUB_S	PROC	NEAR
	MOV	AX,BX
	MOV	BX,10
	XOR	DX,DX
	DIV	BX
	ADD	AL,30H
	ADD	DL,30H
	MOV	BH,AL
	MOV	BL,DL
	RET
SUB_S	ENDP

SUB_S1	PROC	NEAR
	MOV	AX,BX
	MOV	BX,1000
	XOR	DX,DX
	DIV	BX
	ADD	AL,30H
	MOV	CH,AL
	MOV	AX,DX
	XOR	DX,DX
	MOV	BX,100
	DIV	BX
	ADD	AL,30H
	MOV	CL,AL
	MOV	BX,DX
	CALL	SUB_S
	RET
SUB_S1	ENDP

SUB_WDAY	PROC	NEAR
	PUSH	BX
	MOV	FLG,0
	MOV	AH,M
	MOV	AL,BL
	MOV	BX,0
SUB_WDAY_LOOP:
	CMP	AX,WDAY[BX]
	JNE	S_WDAY_NEXT
	COLOR_M	2,0
	CMP	WEEK,0
	JNE	SUB_WDAY_EXIT
	MOV	FLG,1
	JMP	SUB_WDAY_EXIT
S_WDAY_NEXT:
	INC	BX
	INC	BX
	CMP	BX,28
	JA	SUB_WDAY_EXIT
	JMP	SUB_WDAY_LOOP
SUB_WDAY_EXIT:
	POP	BX
	RET
SUB_WDAY	ENDP

SUB_ZOKU	PROC	NEAR
	PUSHA
	MOV	FLG1,0
	MOV	AX,Y
	CMP	AX,YY
	JNE	SUB_ZOKU_EXIT
	MOV	AH,M
	MOV	AL,BL
	CMP	AX,MDAY
	JNE	SUB_ZOKU_EXIT
	MOV	FLG1,1
SUB_ZOKU_EXIT:
	POPA
	RET
SUB_ZOKU	ENDP


SUB_Z	PROC	NEAR
	PUSHA
	PUSH	ES

	MOV	CL,6EH
	MOV	AH,1
	MOV	DX,0040H
	INT	80H

	POP	ES
	POPA
	RET
SUB_Z	ENDP

SUB_Z1	PROC	NEAR
	PUSHA
	PUSH	ES

	MOV	CL,6EH
	MOV	AH,1
	MOV	DX,0F00H
	INT	80H

	POP	ES
	POPA
	RET
SUB_Z1	ENDP

SUB_GR	PROC	NEAR
	PUSHA
	PUSH	ES

	MOV	CL,68H
	MOV	AH,0
	MOV	DX,OFFSET GRCO
	INT	80H
	POP	ES
	PUSH	ES
	MOV	CL,68H
	MOV	AH,1
	MOV	GRCO[1],09H
	MOV	DX,OFFSET GRCO
	INT	80H
	POP	ES
	POPA
	RET
SUB_GR	ENDP

SUB_GR1	PROC	NEAR
	PUSHA
	PUSH	ES

	MOV	CL,68H
	MOV	AH,1
	MOV	GRCO[1],00H
	MOV	DX,OFFSET GRCO
	INT	80H

	POP	ES
	POPA
	RET
SUB_GR1	ENDP


CODE	ENDS
	END	S

